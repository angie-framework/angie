<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/models/BaseModel.es6 | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/benderTheCrime/angie.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/services/$CacheFactory.es6~$CacheFactory.html">$CacheFactory</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/util/$ExceptionsProvider.es6~$Exceptions.html">$Exceptions</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$injector.es6~$Injector.html">$Injector</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/util/$LogProvider.es6~$LogProvider.html">$LogProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Request.es6~$Request.html">$Request</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Responses.es6~$Response.html">$Response</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$RouteProvider.es6~$RouteProvider.html">$RouteProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/controllers/$ScopeProvider.es6~$ScopeProvider.html">$ScopeProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$TemplateCache.es6~$TemplateCache.html">$TemplateCache</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Angular.es6~Angular.html">Angular</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/BaseDBConnection.es6~BaseDBConnection.html">BaseDBConnection</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/Fields.es6~BaseField.html">BaseField</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/BaseModel.es6~BaseModel.html">BaseModel</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/BaseRequest.es6~BaseRequest.html">BaseRequest</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Config.es6~Config.html">Config</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/MySqlConnection.es6~MySqlConnection.html">MySqlConnection</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/SqliteConnection.es6~SqliteConnection.html">SqliteConnection</a></span></li>
</ul>
</div>



<div data-ice="functionWrap">
  <h2><a href="function/">Function</a></h2>
  <ul>
    
  <li data-ice="functionDoc"><span><a href="function/index.html#static-function-AngieDatabaseRouter">AngieDatabaseRouter</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-checkConfig">checkConfig</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-compile">compile</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-createProject">createProject</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-restart">restart</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-shell">shell</a></span></li>
</ul>
</div>






</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/models/BaseModel.es6</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;; &apos;use strong&apos;;

import util from &apos;../util/util&apos;;
import $ExceptionsProvider from &apos;../util/$ExceptionsProvider&apos;;
import AngieDatabaseRouter from &apos;./AngieDatabaseRouter&apos;;

// TODO this should define the default cruddy options that are extended on to the
// existing models

// TODO this should PASS queries through to the ORM based on params
const IGNORE_KEYS = [
    &apos;database&apos;,
    &apos;__database__&apos;,
    &apos;model&apos;,
    &apos;name&apos;,
    &apos;fields&apos;,
    &apos;save&apos;,
    &apos;rows&apos;
];

export class BaseModel {
    constructor(name) {
        this.name = this.name || name;
    }
    all() {

        // Returns all of the rows
        return this.__prep__.apply(this, arguments).all(this.name);
    }
    fetch() {
        let args = arguments[0];
        args.model = this;

        // Returns a subset of rows specified with an int and a head/tail argument
        return this.__prep__.apply(
            this,
            arguments
        ).fetch(args);
    }
    filter() {
        let args = arguments[0];
        args.model = this;

        // Returns a filtered subset of rows
        return this.__prep__.apply(
            this,
            arguments
        ).filter(args);
    }
    exists() {
        return this.filter.apply(this, arguments).then(function(querySet) {
            return !!querySet.length;
        });
    }
    create() {
        let args = arguments[0];
        args.model = this;

        this.database = this.__prep__.apply(this, arguments);

        // Make sure all of our fields are resolved
        let createObj = {},
            me = this;

        this.__fields__().forEach(function(field) {
            const val = args[ field ] || null;
            if (
                me[ field ] &amp;&amp;
                me[ field ].validate &amp;&amp;
                me[ field ].validate(val)
            ) {
                createObj[field] = val;
            } else {
                $ExceptionsProvider.$$invalidModelFieldReference(me.name, field);
            }
        });

        // Once that is settled, we can call our create

        return this.database.create(args);
    }
    delete() {
        let args = arguments[0];
        args.model = this;

        // Delete a record/set of records
        return this.__prep__.apply(
            this,
            arguments
        ).delete(args);
    }
    query(query, args = {}) {
        if (typeof query !== &apos;string&apos;) {
            return new Promise(function() {
                arguments[1](new Error(&apos;Invalid Query String&apos;));
            });
        }
        return this.__prep__.apply(this, args).raw(query, this);
    }
    __prep__() {
        const args = arguments[0],
              database = typeof args === &apos;object&apos; &amp;&amp; args.hasOwnProperty(&apos;database&apos;) ?
                args.database : null;

        // This forces the router to use a specific database, DB can also be
        // forced at a model level by using this.database
        this.__database__ = AngieDatabaseRouter(
            database || this.database || &apos;default&apos;
        );
        return this.__database__;
    }
    __fields__() {
        this.fields = [];
        for (let key in this) {
            if (
                typeof this[ key ] === &apos;object&apos; &amp;&amp;
                IGNORE_KEYS.indexOf(key) === -1
            ) {
                this.fields.push(key);
            }
        }
        return this.fields;
    }
}


// &quot;DO YOU WANT TO CHAIN!? BECAUSE THIS IS HOW YOU CHAIN!&quot;
// TODO this can be made much better once Promise is subclassable
// TODO object prototypes are not extendable with BabelJS
let AngieDBObject = function(database, model, query = &apos;&apos;) {
    if (!database || !model) {
        return;
    }
    this.database = database;
    this.model = model;
    this.query = query;
};

AngieDBObject.prototype.update = function() {
    let args = arguments[0];

    args.model = this.model;
    args.rows = this;
    if (typeof args !== &apos;object&apos;) {
        return;
    }

    let updateObj = {};
    for (let key in args) {
        const val = args[ key ] || null;
        if (IGNORE_KEYS.indexOf(key) &gt; -1) {
            continue;
        }
        else if (
            this[ key ] &amp;&amp;
            this[ key ].validate &amp;&amp;
            this[ key ].validate(val)
        ) {
            updateObj[ key ] = val;
        } else {
            $ExceptionsProvider.$$invalidModelFieldReference(this.name, key);
        }
    }

    util.extend(args, updateObj);
    return this.database.update(args);
};

export {AngieDBObject};
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.2)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
