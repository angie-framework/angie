<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/services/BaseRequest.es6 | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/benderTheCrime/angie.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/services/$CacheFactory.es6~$CacheFactory.html">$CacheFactory</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/util/$ExceptionsProvider.es6~$Exceptions.html">$Exceptions</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$injector.es6~$Injector.html">$Injector</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/util/$LogProvider.es6~$LogProvider.html">$LogProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Request.es6~$Request.html">$Request</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Responses.es6~$Response.html">$Response</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$RouteProvider.es6~$RouteProvider.html">$RouteProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/controllers/$ScopeProvider.es6~$ScopeProvider.html">$ScopeProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$TemplateCache.es6~$TemplateCache.html">$TemplateCache</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Angular.es6~Angular.html">Angular</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/BaseDBConnection.es6~BaseDBConnection.html">BaseDBConnection</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/Fields.es6~BaseField.html">BaseField</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/BaseModel.es6~BaseModel.html">BaseModel</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/BaseRequest.es6~BaseRequest.html">BaseRequest</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Config.es6~Config.html">Config</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/MySqlConnection.es6~MySqlConnection.html">MySqlConnection</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/SqliteConnection.es6~SqliteConnection.html">SqliteConnection</a></span></li>
</ul>
</div>



<div data-ice="functionWrap">
  <h2><a href="function/">Function</a></h2>
  <ul>
    
  <li data-ice="functionDoc"><span><a href="function/index.html#static-function-AngieDatabaseRouter">AngieDatabaseRouter</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-checkConfig">checkConfig</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-compile">compile</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-createProject">createProject</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-restart">restart</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-shell">shell</a></span></li>
</ul>
</div>






</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/services/BaseRequest.es6</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;; &apos;use strong&apos;;

import app from &apos;../Base&apos;;
import {config} from &apos;../Config&apos;;
import util from &apos;../util/util&apos;;
import $log from &apos;../util/$LogProvider&apos;;
import $Request from &apos;./$Request&apos;;
import {$Response} from &apos;./$Responses&apos;;
import {$routeProvider} from &apos;./$RouteProvider&apos;;
import {$templateCache, $templateLoader} from &apos;./$TemplateCache&apos;;
import {$injectionBinder} from &apos;./$Injector&apos;;
import __mimetypes__ from &apos;../util/MimeTypes&apos;;
import $compile from &apos;./$Compile&apos;;


// TODO move these out to a constant
const DEFAULT_CONTENT_TYPE = {
          &apos;Content-Type&apos;: &apos;text/plain&apos;
      },
      RESPONSE_HEADER_MESSAGES = {
          &apos;200&apos;: &apos;OK&apos;,
          &apos;404&apos;: &apos;File Not Found&apos;,
          &apos;500&apos;: &apos;Invalid Request&apos;
      },
      PRAGMA_HEADER = &apos;no-cache&apos;,
      NO_CACHE_HEADER = &apos;private, no-cache, no-store, must-revalidate&apos;;

class BaseRequest {
    constructor(path, request, response) {

        // Cases:
        // Controller &amp; templatePath (default) --&gt; compiles template in scope
        // --&gt; view
        // Controler &amp; template --&gt; compiles template in scope
        // --&gt; view
        // Controller --&gt; fires Controller, expects response
        // --&gt; view
        // templatePath (default) --&gt; serves template, expects compilation on frontend
        // template --&gt; serves template, expects compilation on frontend
        // --&gt; no views

        // Define URI
        this.path = path;

        // Shortcut to set and receive the request object
        this.request = new $Request(request).request;

        // Make the response object available to the API
        response.__responseContent__ = &apos;&apos;;
        this.response = new $Response(response).response;

        // Parse out the response content type
        let contentType = this.request.headers.accept;

        if (contentType &amp;&amp; contentType.indexOf(&apos;,&apos;) &gt; -1) {
            contentType = contentType.split(&apos;,&apos;)[0];
        } else if (
            path.indexOf(&apos;.&apos;) &gt; -1  &amp;&amp;

            // TODO mimetypes should never return undefined
            __mimetypes__[ path.split(&apos;.&apos;).pop() ]
        ) {
            contentType = __mimetypes__[ path.split(&apos;.&apos;).pop() ];
        } else {
            contentType = &apos;text/plain&apos;;
        }

        this.responseContentType = contentType;
        this.responseHeaders = {
            &apos;Content-Type&apos;: this.responseContentType
        };

        // Grab the routes and the otherwise
        this.routes = $routeProvider.fetch().routes;
        this.otherwise = $routeProvider.fetch().otherwise;
    }
    route() {

        // If the route exists:
        if (this.routes[ this.path ]) {
            this.route = this.routes[ this.path ];

            return this.controllerPath();
        } else {
            return this.otherPath();
        }
    }
    controllerPath() {
        let me = this,
            prom,
            error = false;

        prom = new Promise(function(resolve, reject) {
            let controllerName = me.route.Controller;

            // Get controller and compile scope
            if (controllerName) {
                if(app.Controllers[ controllerName ]) {
                    let controller = app.Controllers[ controllerName ];

                    app.Controller = app.services.$response.Controller = {
                        done: resolve
                    };

                    me.controller = new $injectionBinder(controller)(resolve);
                    if (
                        !me.controller ||
                        !me.controller.constructor ||
                        me.controller.constructor.name !== &apos;Promise&apos;
                    ) {
                        resolve();
                    }
                } else {

                    // TODO controller was not found despite being defined?
                    // TODO exception
                    $log.error(`No Controller named &quot;${controllerName}&quot; could be found`);
                    reject();
                }
            } else {
                resolve();
            }
        });

        // Find and load template
        prom.then(function() {
            console.log(&apos;DO I GET HERE&apos;);
            try {
                if (
                    me.route.template &amp;&amp;
                    typeof me.route.template === &apos;string&apos; &amp;&amp;
                    me.route.template.length &gt; 0
                ) {
                    me.template = me.route.template;

                } else if (me.route.templatePath) {

                    // Check to see if we can associate the template path with a
                    // mime type
                    if (
                        me.route.templatePath.indexOf(&apos;.&apos;) &gt; -1 &amp;&amp;

                        // TODO mimetypes should never return undefined
                        __mimetypes__[
                           me.route.templatePath.split(&apos;.&apos;).pop()
                       ]
                    ) {
                        me.responseHeaders[ &apos;Content-Type&apos; ] = __mimetypes__[
                            me.route.templatePath.split(&apos;.&apos;).pop()
                        ];
                    }
                    me.template = $templateCache.get(me.route.templatePath);
                }

                // If there is a template/templatePath defined we should have a template
                if (
                    (me.route.template || me.route.templatePath) &amp;&amp;
                    !me.template
                ) {
                    return me.errorPath();
                } else if (
                    config.hasOwnProperty(&apos;cacheStaticAssets&apos;) &amp;&amp;
                    !config.cacheStaticAssets
                ) {

                    // If there is a template, check to see if caching is set
                    me.responseHeaders = util.extend(me.responseHeaders, {
                        &apos;Expires&apos;: -1,
                        &apos;Pragma&apos;: PRAGMA_HEADER,
                        &apos;Cache-Control&apos;: NO_CACHE_HEADER
                    });
                }

                // Pull the response back in from wherever it was before
                me.responseContent = me.response.__responseContent__;

                // TODO ^^ Still need to check here whether there is a template?
                if (me.template) {

                    // TODO render the template into the resoponse
                    me.responseContent += $compile(me.template)(app.services.$scope);

                    // TODO does this cause issues with directives
                    me.response.__responseContent__ = me.responseContent;
                }
            } catch(e) {
                error = !!e;
            } finally {
                console.log(&apos;ALSO HERE&apos;);
                return true;
            }
        });

        // TODO See if any views have this Controller associated
        // TODO instantiate directives beforehand
        // for (let key in app.directives) {
        //     let directive = app.directives[ key ];
        //     if (
        //         directive.Controller &amp;&amp;
        //         directive.Controller === controllerName
        //     ) {
        //
        //         if (directive.type === &apos;APIView&apos;) {
        //
        //             // APIViews cannot have templates, all templates are trashed
        //             delete this.template;
        //             // delete this.__responseContent__;
        //             this.responseHeaders = {};
        //
        //             // TODO fire off link
        //         }
        //
        //         // TODO the execution of these directives should only occur
        //         // in template compilation
        //         // else if (directive.type === &apos;TemplateView&apos;) {
        //         //
        //         // }
        //     }
        // }

        prom.then(function() {
            if (error) {
                $log.error(error);
                me.response.writeHead(
                    500,
                    RESPONSE_HEADER_MESSAGES[&apos;500&apos;],
                    me.responseHeaders
                );
                me.response.write(`&lt;h1&gt;${RESPONSE_HEADER_MESSAGES[&apos;500&apos;]}&lt;/h1&gt;`);
            } else {
                me.response.writeHead(
                    200,
                    RESPONSE_HEADER_MESSAGES[&apos;200&apos;],
                    me.responseHeaders
                );
                me.response.write(me.responseContent);
            }
            console.log(&apos;AND HERE&apos;);
            return true;
        });

        return prom;
    }
    otherPath() {
        let me = this;

        if (this.otherwise) {

            // Redirect the page to a default page
            // TODO test otherwise redirects to absolute path or full link
            return new Promise(function() {
                me.response.statusCode = 302;
                me.response.setHeader(&apos;Location&apos;, `${me.otherwise}`);
                arguments[0]();
            });
        }

        return this[ `${this.path === &apos;/&apos; ? &apos;default&apos; : &apos;error&apos;}Path` ]();
    }
    defaultPath() {

        // Load default page
        let index = $templateLoader(&apos;index.html&apos;);

        // If the index page could not be found
        if (!index) {
            return this.errorPath();
        }

        // Write the response
        let me = this;
        return new Promise(function() {
            me.response.writeHead(
                200,
                RESPONSE_HEADER_MESSAGES[&apos;200&apos;],
                me.responseHeaders
            );
            me.response.write(index);
            arguments[0]();
        });
    }
    errorPath() {

        // Load page not found
        let fourOhFour = $templateLoader(&apos;404.html&apos;);


        let me = this;
        return new Promise(function() {
            me.response.writeHead(
                404,
                RESPONSE_HEADER_MESSAGES[&apos;404&apos;],
                me.responseHeaders
            );
            me.response.write(fourOhFour);
        });
    }
}

export {
    BaseRequest,
    DEFAULT_CONTENT_TYPE,
    RESPONSE_HEADER_MESSAGES,
    PRAGMA_HEADER,
    NO_CACHE_HEADER
};
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.2)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
