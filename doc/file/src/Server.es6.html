<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Server.es6 | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/benderTheCrime/angie.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/services/$CacheFactory.es6~$CacheFactory.html">$CacheFactory</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/util/$ExceptionsProvider.es6~$Exceptions.html">$Exceptions</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$injector.es6~$Injector.html">$Injector</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/util/$LogProvider.es6~$LogProvider.html">$LogProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Request.es6~$Request.html">$Request</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Responses.es6~$Response.html">$Response</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$RouteProvider.es6~$RouteProvider.html">$RouteProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/controllers/$ScopeProvider.es6~$ScopeProvider.html">$ScopeProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$TemplateCache.es6~$TemplateCache.html">$TemplateCache</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Angular.es6~Angular.html">Angular</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/BaseDBConnection.es6~BaseDBConnection.html">BaseDBConnection</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/Fields.es6~BaseField.html">BaseField</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/BaseModel.es6~BaseModel.html">BaseModel</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/BaseRequest.es6~BaseRequest.html">BaseRequest</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Config.es6~Config.html">Config</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/MySqlConnection.es6~MySqlConnection.html">MySqlConnection</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/models/SqliteConnection.es6~SqliteConnection.html">SqliteConnection</a></span></li>
</ul>
</div>



<div data-ice="functionWrap">
  <h2><a href="function/">Function</a></h2>
  <ul>
    
  <li data-ice="functionDoc"><span><a href="function/index.html#static-function-AngieDatabaseRouter">AngieDatabaseRouter</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-checkConfig">checkConfig</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-compile">compile</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-createProject">createProject</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-restart">restart</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-shell">shell</a></span></li>
</ul>
</div>






</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Server.es6</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;; &apos;use strong&apos;;

import {config} from &apos;./Config&apos;;
import app from &apos;./Base&apos;;
import $cacheFactory from &apos;./services/$CacheFactory&apos;;
import {$templateLoader} from &apos;./services/$TemplateCache&apos;;
import {
    BaseRequest,
    RESPONSE_HEADER_MESSAGES,
    PRAGMA_HEADER,
    NO_CACHE_HEADER
} from &apos;./services/BaseRequest&apos;;
import util from &apos;./util/util&apos;;
import __mimetypes__ from &apos;./util/MimeTypes&apos;;
import $log from &apos;./util/$LogProvider&apos;;

const http =        require(&apos;http&apos;),
      url =         require(&apos;url&apos;),
      watch =       require(&apos;node-watch&apos;);

const p = process;

let firstrun = true,
    port;

export default function server(args) {
    port = !isNaN(+args[2]) ? args[2] : 3000;

    if (firstrun) {
        $log.warn(&apos;&quot;server&quot; not suitable for production use.&apos;);
    }

    prepApp().then(function() {

        // Start a webserver
        // TODO run the webserver with Gulp and gulp watch project files and angie files to reload
        http.createServer(function(request, response) {
            let path = url.parse(request.url).pathname,
                angieResponse = new BaseRequest(path, request, response),
                asset;

            // A file cannot be in the static path if it doesn&apos;t have an extension, shortcut
            // TODO you may want to move the asset loading block out of here
            if (path.indexOf(&apos;.&apos;) &gt; -1) {
                let assetCache = new $cacheFactory(&apos;staticAssets&apos;);

                if (assetCache.get(path)) {
                    asset = assetCache.get(path);
                } else {
                    asset = $templateLoader(path, &apos;static&apos;);
                }

                // We have an asset and must render a response
                if (asset) {

                    let contentType;

                    // TODO mimetypes should never return undefined
                    if (__mimetypes__[ path.split(&apos;.&apos;).pop() ]) {
                        contentType = __mimetypes__[
                            path.split(&apos;.&apos;).pop()
                        ];
                    } else {
                        contentType = &apos;text/plain&apos;;
                    }

                    // Set the content type
                    angieResponse.responseHeaders[ &apos;Content-Type&apos; ] = contentType;

                    // We do not want to cache responses
                    if (
                        config.hasOwnProperty(&apos;cacheStaticAssets&apos;) &amp;&amp;
                        !config.cacheStaticAssets
                    ) {
                        angieResponse.responseHeaders = util.extend(
                            angieResponse.responseHeaders,
                            {
                                &apos;Expires&apos;: -1,
                                &apos;Pragma&apos;: PRAGMA_HEADER,
                                &apos;Cache-Control&apos;: NO_CACHE_HEADER
                            }
                        );
                    }

                    response.writeHead(
                        200,
                        RESPONSE_HEADER_MESSAGES[&apos;200&apos;],
                        angieResponse.responseHeaders
                    );

                    // Check if you have an image type asset
                    $log.info(path, response._header);
                    response.write(asset);
                } else {

                    // We have no asset and must render a response
                    const error = $templateLoader(&apos;404.html&apos;);

                    // TODO extrapolate this to responses
                    response.writeHead(
                        404,
                        RESPONSE_HEADER_MESSAGES[&apos;404&apos;],
                        angieResponse.responseHeaders
                    );
                    $log.warn(path, response._header);
                    response.write(error);
                }

                // End the response
                response.end();
            } else {
                angieResponse.route().then(function() {
                    console.log(&apos;DO I GET IN?&apos;);
                    let code = response.statusCode;
                    console.log(code);
                    if (!code) {
                        const error = $templateLoader(&apos;500.html&apos;);

                        // TODO extrapolate this to responses
                        response.writeHead(
                            500,
                            RESPONSE_HEADER_MESSAGES[&apos;500&apos;],
                            angieResponse.responseHeaders
                        );
                        response.write(error);
                        $log.error(path, response._header);
                    } else if (code &lt; 400) {
                        console.log($log.info, response._header);
                        $log.info(path, response._header);
                    } else if (code &lt; 500) {
                        $log.warn(path, response._header);
                    } else {
                        $log.error(path, response._header);
                    }
                    console.log(&apos;__DO I GET IN?&apos;);
                    return true;
                }).then(function() {
                    console.log(&apos;DONE&apos;);

                    // End the response
                    response.end();
                });
            }

            // TODO this seems to cause ERR_INCOMPLETE_CHUNKED_ENCODING
            // request.connection.end();
            // request.connection.destroy();
        }).listen(+port);

        // Attempt to restart the webserver on change
        if (firstrun) {
            let watchDirs = [ p.cwd(), __dirname ].concat(app.__dependencies__);

            try {
                let restartObj = {
                        persistent: true,
                        recursive: true
                    };
                watch(watchDirs, (() =&gt; restart()), restartObj);
            } catch(e) {
                $log.error(e);
            }
        }

        // Info
        $log.info(`Serving on port ${port}`);

        // Set firstrun to false
        firstrun = false;
    });
}

function restart() {

    // TODO this doesn&apos;t reload like you think it does
    prepApp().then(function() {
        $log.info(`Application files reloaded; Still serving on port ${port}`);
    });

    // TODO live reload
}

export function prepApp() {

    // Load any app dependencies
    return app.loadDependencies(config.dependencies).then(function() {

        // Bootstrap the angular application
        return new Promise(
            (resolve) =&gt; app.bootstrap().then(
                app.__dropBootstrapMethods__
            ).then(resolve)
        );
    });
}
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.2)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
