<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/factories/$TemplateCache.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/benderTheCrime/angie.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/util/$ExceptionsProvider.js~$$InvalidConfigError.html">$$InvalidConfigError</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/factories/$CacheFactory.js~$CacheFactory.html">$CacheFactory</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/util/$MimeTypeProvider.js~$MimeTypeProvider.html">$MimeTypeProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Request.js~$Request.html">$Request</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/$Responses.js~$Response.html">$Response</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/factories/$RouteProvider.js~$RouteProvider.html">$RouteProvider</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/factories/$TemplateCache.js~$TemplateCache.html">$TemplateCache</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/factories/$Compile.js~$window.html">$window</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Angie.js~Angie.html">Angie</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/services/BaseRequest.js~BaseRequest.html">BaseRequest</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Config.js~Config.html">Config</a></span></li>
</ul>
</div>



<div data-ice="functionWrap">
  <h2><a href="function/">Function</a></h2>
  <ul>
    
  <li data-ice="functionDoc"><span><a href="function/index.html#static-function-Base">Base</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-shell">shell</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-watch">watch</a></span></li>
</ul>
</div>






</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/factories/$TemplateCache.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">/**
 * @module $TemplateCache.js
 * @author Joe Groseclose &lt;@benderTheCrime&gt;
 * @date 8/16/2015
 */

// System Modules
import fs from                      &apos;fs&apos;;
import {default as $Injector} from  &apos;angie-injector&apos;;

// Angie Modules
import {config} from                &apos;../Config&apos;;
import $CacheFactory from           &apos;./$CacheFactory&apos;;
import {
    $StringUtil,
    $FileUtil
} from                              &apos;../util/Util&apos;;

const p = process,
      ANGIE_TEMPLATE_DIRS = [
          `${__dirname}/../templates/html`,
          `${__dirname}/../../test/src/templates`
      ],
      ANGIE_STATIC_DIRS = [];

class $TemplateCache extends $CacheFactory {
    constructor() {
        super(&apos;templateCache&apos;);
    }
    get(url) {
        let template = super.get(url);
        if (!template) {
            template = $$templateLoader(url);
        }
        if (template &amp;&amp; config.cacheStaticAssets) {
            this.put(url, template);
        }
        return template;
    }
}

function $$templateLoader(url, type = &apos;template&apos;, encoding) {

    // Clone them template dirs
    let templateDirs = (
        config[ `${type}Dirs` ].slice() || []
    ),
    template;

    // Add the default Angie template dirs to the existing config template dirs
    templateDirs = templateDirs.concat(
        type === &apos;template&apos; ? ANGIE_TEMPLATE_DIRS :
            type === &apos;static&apos; ? ANGIE_STATIC_DIRS : []
    );

    templateDirs = templateDirs.map(function(dir) {
        if (
            (
                (type === &apos;template&apos; &amp;&amp; ANGIE_TEMPLATE_DIRS.indexOf(dir) === -1) ||
                (type === &apos;static&apos; &amp;&amp; ANGIE_STATIC_DIRS.indexOf(dir) === -1)
            ) &amp;&amp;
            dir.indexOf(p.cwd()) === -1
        ) {
            dir = $StringUtil.removeLeadingSlashes(dir);
            dir = `${p.cwd()}/${dir}`;
        }
        dir = $StringUtil.removeTrailingSlashes(dir);
        return dir;
    });

    // Deliberately use a for loop so that we can break out of it
    for (var i = templateDirs.length - 1; i &gt;= 0; --i) {
        let dir = templateDirs[i],
            path = $FileUtil.find(dir, url);

        if (typeof path === &apos;string&apos;) {
            template = fs.readFileSync(path, encoding || undefined);
        }

        if (template) {
            break;
        }
    }

    if (!template) {
        return false;
    } else if (
        type === &apos;static&apos; &amp;&amp;
        config.hasOwnProperty(&apos;cacheStaticAssets&apos;) &amp;&amp;
        config.cacheStaticAssets === true
    ) {
        // TODO you may want to put this in the asset loading block
        new $CacheFactory(&apos;staticAssets&apos;).put(url, template);
    }
    return template;
}

/**
 * @desc $resourceLoader is a factory that will attach a JavaScript resource
 * to any respose. It will attach it inside of the body if the file is requested
 * to be attached on an HTML response.
 * @since 0.3.2
 * @todo Make this work with .css, .less, .scss, .haml
 * @todo Auto load Angular, jQuery, Underscore, etc. from their names alone
 * via Bower installs. Must create bower.json &amp; bump bower version.
 * @param {string|Array} [param=10] filename Valid JS filename in Angie static
 * directories
 * @param {string} [param=&apos;src&apos;] loadStyle How is this resource attached to the
 * document. Options:
 *     &apos;src&apos;:       Include a script tag with the name of the resource
 *     &apos;inline&apos;:    Include the resource content inline
 * @returns {boolean} Whether this function successfully finished (not an
 * indication that the resource was actually attached)
 * @access public
 * @example $resourceLoader(&apos;test.js&apos;);
 */
function $resourceLoader(files = [], loadStyle = &apos;src&apos;) {
    console.log(&apos;IN RESOURCE LOADER&apos;, files);
    let [ $request, $response ] = $Injector.get(&apos;$request&apos;, &apos;$response&apos;);
    console.log(&apos;RESPONSE&apos;, $response);
    if (!$response || typeof $response !== &apos;object&apos;) {
        return false;
    } else if (!$response.$responseContent) {

        // Just in case the response property was not already defined
        $response.$responseContent = &apos;&apos;;
    }

    if (typeof files === &apos;string&apos;) {
        files = [ files ];
    }

    files.forEach(function(resource) {

        // Return if not a js file
        if (resource.split(&apos;.&apos;).pop() !== &apos;js&apos;) {
            return;
        }

        console.log(&apos;IN RESOURCE LOADER&apos;, resource);


        // TODO put this into a template?
        let asset = &apos;&lt;script type=&quot;text/javascript&quot;&apos;;
        if (loadStyle === &apos;src&apos;) {
            asset += ` src=&quot;${[
                $StringUtil.removeTrailingSlashes($request.path)
                    .replace(/([A-Za-z]+)/g, &apos;..&apos;),
                resource
            ].join(&apos;/&apos;)}&quot;&gt;`;
        } else {
            let assetCache = new $CacheFactory(&apos;staticAssets&apos;),
                assetPath = resource.split(&apos;/&apos;).pop(),
                staticAsset;

            asset += &apos;&gt;&apos;;
            if (assetCache.get(assetPath)) {
                staticAsset = assetCache.get(assetPath);
            } else {
                staticAsset = $$templateLoader(assetPath, &apos;static&apos;, &apos;utf8&apos;);
            }

            if (staticAsset.length) {
                asset += `${staticAsset}`;
            }
        }

        asset += &apos;&lt;/script&gt;&apos;;

        console.log(&apos;ASSET&apos;, asset);

        const BODY = &apos;&lt;/body&gt;&apos;,
            STR = $response.$responseContent;
        if (STR.indexOf(BODY) &gt; -1) {
            let body = STR.lastIndexOf(BODY);

            console.log(&apos;IN BODY&apos;);

            $response.$responseContent =
                `${STR.substr(0, body)}${asset}${STR.substr(body)}`;
        } else {
            $response.$responseContent = $response.$responseContent + asset;
        }
        console.log(&apos;content&apos;, $response.$responseContent);
    });
    return true;
}

const $templateCache = new $TemplateCache();
export {
    $templateCache,
    $$templateLoader,
    $resourceLoader
};
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.2)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
